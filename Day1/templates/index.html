<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.H.I.E.L.D. Pattern Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* bg-slate-900 */
        }
        /* Custom scrollbar for the terminal */
        pre::-webkit-scrollbar {
            width: 8px;
        }
        pre::-webkit-scrollbar-track {
            background: #1E293B; /* bg-slate-800 */
        }
        pre::-webkit-scrollbar-thumb {
            background: #334155; /* bg-slate-700 */
            border-radius: 4px;
        }
        pre::-webkit-scrollbar-thumb:hover {
            background: #475569; /* bg-slate-600 */
        }
        /* Blinking cursor effect */
        .cursor {
            display: inline-block;
            width: 10px;
            height: 1.2rem;
            background-color: #34D399; /* emerald-400 */
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="h-full w-full bg-slate-900 text-slate-200 flex items-center justify-center p-4">

    <!-- Main Terminal Interface -->
    <div class="w-full max-w-4xl bg-slate-800 rounded-lg shadow-2xl border border-cyan-500/30 overflow-hidden">
        
        <!-- Header Bar -->
        <div class="flex items-center justify-between bg-slate-950 p-4 border-b border-slate-700">
            <div class="flex items-center space-x-3">
                <!-- S.H.I.E.L.D. Logo (Inline SVG) -->
                <svg class="h-10 w-10 text-cyan-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v3.5A1.5 1.5 0 0010.5 10h3.5a.75.75 0 000-1.5h-3.5a.25.25 0 01-.25-.25V5z" clip-rule="evenodd" />
                    <path d="M10 2a1 1 0 011 1v4.417l3.72 3.72a.75.75 0 01-1.06 1.06L10 8.56V17a1 1 0 11-2 0V8.56l-3.66 3.66a.75.75 0 01-1.06-1.06L7 7.417V3a1 1 0 011-1h2z" />
                    <path fill-rule="evenodd" d="M10 2.25c-4.28 0-7.75 3.47-7.75 7.75s3.47 7.75 7.75 7.75 7.75-3.47 7.75-7.75S14.28 2.25 10 2.25zM1.5 10a8.5 8.5 0 1117 0 8.5 8.5 0 01-17 0z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M12.29 4.97a.75.75 0 011.06 0l3.5 3.5a.75.75 0 010 1.06l-3.5 3.5a.75.75 0 01-1.06-1.06L14.94 10l-2.65-2.65a.75.75 0 010-1.06zM7.71 4.97a.75.75 0 00-1.06 0l-3.5 3.5a.75.75 0 000 1.06l3.5 3.5a.75.75 0 001.06-1.06L5.06 10l2.65-2.65a.75.75 0 000-1.06z" clip-rule="evenodd" />
                </svg>
                <h1 class="text-xl font-bold text-cyan-400 tracking-wider">S.H.I.E.L.D. // PATTERN PROTOCOL</h1>
            </div>
            <div class="flex space-x-2">
                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-6 md:flex md:space-x-6">
            
            <!-- Left Panel: Briefing & Terminal -->
            <div class="md:w-2/3 space-y-4">
                <div>
                    <h2 class="text-lg font-semibold text-white">MISSION BRIEFING // FILE: #808</h2>
                    <p class="text-slate-400 text-sm mt-2">
                        Each recruit receives one data file. Each file contains a sequence of numbers following a hidden pattern. Participants must observe and find the logic, then predict the two missing values to gain access.
                    </p>
                </div>
                
                <div class="bg-black rounded-md p-4 border border-slate-700 shadow-inner">
                    <div class="flex items-center space-x-2">
                        <span class="text-green-400">$ cat /missions/protocol_data.csv</span>
                        <span class="cursor"></span>
                    </div>
                    <pre id="csv-display" class="font-mono text-sm text-slate-300 mt-2 p-2 bg-slate-950 rounded overflow-auto h-48">Loading mission data...</pre>
                </div>
            </div>

            <!-- Right Panel: Analysis & Submission -->
            <div class="md:w-1/3 space-y-4 mt-6 md:mt-0">
                <div class="absolute top-4 right-4">
                    <span class="text-red-500 font-bold text-xs border-2 border-red-500 p-1 rounded">CLASSIFIED</span>
                </div>
                
                <h2 class="text-lg font-semibold text-white">ANALYSIS & SUBMISSION</h2>
                
                <form id="submission-form" class="space-y-4">
                    <div>
                        <label for="guess1" class="block text-sm font-medium text-slate-300">Missing Value 1 (Prediction)</label>
                        <input type="number" id="guess1" name="guess1" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Enter first '?' value" required>
                    </div>
                    
                    <div>
                        <label for="guess2" class="block text-sm font-medium text-slate-300">Missing Value 2 (Prediction)</label>
                        <input type="number" id="guess2" name="guess2" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500" placeholder="Enter second '?' value" required>
                    </div>
                    
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-lg text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-cyan-500 transition-all duration-150 transform hover:scale-105">
                        SUBMIT ANALYSIS
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal for Success/Failure -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75 backdrop-blur-sm hidden">
        <div id="modal-panel" class="w-full max-w-md bg-slate-800 rounded-lg shadow-2xl border border-slate-700">
            <div class="p-6 text-center">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full">
                    <!-- Icon here (SVG) -->
                </div>
                <h3 id="modal-title" class="text-2xl font-bold mt-4"></h3>
                <p id="modal-message" class="text-slate-300 mt-2"></p>
                <button id="modal-button" class="mt-6 w-full py-2 px-4 rounded-md shadow-lg font-medium text-white transition-all duration-150">
                    <!-- Button text here -->
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentAnswers = []; // This will be set by the server response

        // --- DOM ELEMENTS ---
        const csvDisplay = document.getElementById('csv-display');
        const submissionForm = document.getElementById('submission-form');
        const guess1Input = document.getElementById('guess1');
        const guess2Input = document.getElementById('guess2');
        
        const modal = document.getElementById('modal');
        const modalPanel = document.getElementById('modal-panel');
        const modalIcon = document.getElementById('modal-icon');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButton = document.getElementById('modal-button');

        // --- MODAL FUNCTIONS ---

        function showModal(type) {
            // Clear previous states
            modalIcon.innerHTML = '';
            modalPanel.classList.remove('border-green-500', 'border-red-500');
            modalButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-red-600', 'hover:bg-red-700', 'bg-cyan-600', 'hover:bg-cyan-700');
            modalTitle.classList.remove('text-green-400', 'text-red-400');

            if (type === 'success') {
                modalPanel.classList.add('border-green-500');
                modalIcon.innerHTML = `<svg class="h-10 w-10 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                modalTitle.textContent = 'ACCESS GRANTED';
                modalTitle.classList.add('text-green-400');
                modalMessage.textContent = 'Analysis confirmed. Your logic is sound. Welcome to the Protocol, Agent. Proceeding to the next stage...';
                
                // On success, button fetches link.txt and redirects
                modalButton.textContent = 'Proceed to Next Stage';
                modalButton.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
                modalButton.onclick = () => {
                    // Fetch the link from link.txt (served from the 'static' folder)
                    fetch('link.txt')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('link.txt not found.');
                            }
                            return response.text();
                        })
                        .then(link => {
                            // Redirect to the URL found in the file
                            window.location.href = link.trim(); 
                        })
                        .catch(err => {
                            console.error('Redirect failed:', err);
                            modalMessage.textContent = 'Error: Could not find redirect file (link.txt). Please contact admin.';
                        });
                };
            } else {
                modalPanel.classList.add('border-red-500');
                modalIcon.innerHTML = `<svg class="h-10 w-10 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.309-.284-2.56-.798-3.75a11.959 11.959 0 01-5.602-1.784zM12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 12.376z" /></svg>`;
                modalTitle.textContent = 'ACCESS DENIED';
                modalTitle.classList.add('text-red-400');
                modalMessage.textContent = 'Protocol mismatch. Your analysis is flawed. Re-evaluate the data and try again.';
                modalButton.textContent = 'Understood';
                modalButton.classList.add('bg-red-600', 'hover:bg-red-700');
                modalButton.onclick = hideModal;
            }
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
        }

        // --- MISSION LOGIC ---

        /**
         * Loads a new mission from the server
         */
        function loadMission() {
            // Reset form
            submissionForm.reset();
            csvDisplay.textContent = "Requesting new mission file from S.H.I.E.L.D. servers...";

            // Fetch mission data from the Flask server
            fetch('/get-mission')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    // Set the global answers and display the CSV data from the server
                    currentAnswers = data.answers;
                    csvDisplay.textContent = data.csv_data;
                })
                .catch(err => {
                    console.error('Failed to load mission:', err);
                    csvDisplay.textContent = `--- CONNECTION ERROR ---\nFailed to load mission file.\n${err.message}\n\nEnsure server is running and dataset files are in the 'static' folder.`;
                });
        }

        /**
         * Handles form submission
         */
        function handleSubmit(event) {
            event.preventDefault();
            const guess1 = parseInt(guess1Input.value, 10);
            const guess2 = parseInt(guess2Input.value, 10);

            // Check if guesses match the stored answers
            // This assumes the answers are in the correct order, which the server ensures
            if (guess1 === currentAnswers[0] && guess2 === currentAnswers[1]) {
                showModal('success');
            } else {
                showModal('failure');
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            submissionForm.addEventListener('submit', handleSubmit);
            loadMission(); // Load the first mission on page load
        });

    </script>
</body>
</html>

